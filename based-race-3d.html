<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Based Race 3D</title>
  <style>
    body { margin: 0; overflow: hidden; background: #0a0a0f; font-family: sans-serif; }
    canvas { display: block; }
    #ui { position: absolute; top: 10px; left: 10px; color: #0ff; font-size: 20px; }
    #status { position: absolute; top: 10px; right: 10px; color: gold; font-size: 20px; }
    #start { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    #start h1 { color: #e94560; font-size: 40px; margin: 0; }
    #start button { padding: 15px 40px; font-size: 20px; background: #e94560; color: white; border: none; border-radius: 30px; cursor: pointer; margin-top: 20px; }
    #controls { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: space-around; }
    .btn { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; color: white; font-size: 30px; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>
  <div id="ui">00:00.00</div>
  <div id="status">BASED RACE 3D</div>
  <div id="start">
    <h1>BASED RACE</h1>
    <p style="color:#888">Tap LEFT/RIGHT to move</p>
    <button onclick="start()">START</button>
  </div>
  <div id="controls">
    <div class="btn" ontouchstart="move(-1)" onmousedown="move(-1)">â—€</div>
    <div class="btn" ontouchstart="move(1)" onmousedown="move(1)">â–¶</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script>
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1a2e);
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
    camera.position.set(0, 4, 8);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    document.body.insertBefore(renderer.domElement, document.body.firstChild);
    scene.add(new THREE.AmbientLight(0xffffff, 0.9));
    const dir = new THREE.DirectionalLight(0xffffff, 0.5);
    dir.position.set(5,10,5);
    scene.add(dir);

    let running = false, time = 0, speed = 0;
    const racers = [], lanes = [-2, -0.7, 0.7, 2];
    const colors = [0x00bcd4, 0x9c27b0, 0xff9800, 0xe94560];
    const names = ['Jesse', 'Barmstrong', 'Deployer', 'Dish'];

    // Road
    for(let i=0; i<50; i++) {
      const seg = new THREE.Group();
      seg.position.z = -i * 10;
      const road = new THREE.Mesh(new THREE.PlaneGeometry(6, 10), new THREE.MeshStandardMaterial({color: 0x333333}));
      road.rotation.x = -Math.PI/2;
      seg.add(road);
      const edge = new THREE.MeshBasicMaterial({color: i%2?0xe94560:0xffffff});
      [-3,3].forEach(x => {
        const e = new THREE.Mesh(new THREE.PlaneGeometry(0.1, 10), edge);
        e.rotation.x = -Math.PI/2;
        e.position.set(x, 0.01, 0);
        seg.add(e);
      });
      if(i===1) {
        const start = new THREE.Mesh(new THREE.PlaneGeometry(6, 1), new THREE.MeshBasicMaterial({color: 0x00ff00}));
        start.rotation.x = -Math.PI/2;
        start.position.set(0, 0.02, 0);
        seg.add(start);
      }
      if(i===47) {
        for(let c=0; c<6; c++) {
          const ckr = new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({color: c%2?0:0xfff}));
          ckr.rotation.x = -Math.PI/2;
          ckr.position.set(-2.5+c, 0.02, 0);
          seg.add(ckr);
        }
      }
      scene.add(seg);
      racers.push({seg, z: -i*10});
    }

    // Karts
    const karts = [];
    names.forEach((name, i) => {
      const kart = new THREE.Group();
      const body = new THREE.Mesh(new THREE.BoxGeometry(0.7, 0.4, 1.2), new THREE.MeshStandardMaterial({color: colors[i]}));
      body.position.y = 0.3;
      kart.add(body);
      const helm = new THREE.Mesh(new THREE.SphereGeometry(0.2, 12, 12), new THREE.MeshStandardMaterial({color: 0xffd700}));
      helm.position.y = 0.7;
      kart.add(helm);
      [[-0.4,0.15,0.4],[0.4,0.15,0.4],[-0.4,0.15,-0.4],[0.4,0.15,-0.4]].forEach(p => {
        const w = new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,0.1,8), new THREE.MeshStandardMaterial({color: 0x111}));
        w.rotation.z = Math.PI/2;
        w.position.set(...p);
        kart.add(w);
      });
      kart.position.x = lanes[i];
      scene.add(kart);
      karts.push({kart, lane: i, targetX: lanes[i], x: lanes[i], speed: 0.04+Math.random()*0.02, progress: 0});
    });

    function move(dir) {
      if(!running) return;
      const p = karts[0];
      if(dir<0 && p.lane>0) p.lane--;
      if(dir>0 && p.lane<3) p.lane++;
      p.targetX = lanes[p.lane];
    }

    function start() {
      document.getElementById('start').style.display = 'none';
      running = true;
      time = 0;
      speed = 0.2;
      karts.forEach(k => { k.progress = 0; k.kart.position.z = 0; });
    }

    document.onkeydown = e => {
      if(e.key==='ArrowLeft'||e.key==='a') move(-1);
      if(e.key==='ArrowRight'||e.key==='d') move(1);
    };

    function update() {
      requestAnimationFrame(update);
      if(!running) { renderer.render(scene, camera); return; }
      
      time += 0.016;
      if(speed < 0.6) speed += 0.005;
      
      const ui = document.getElementById('ui');
      const m = Math.floor(time/60), s = Math.floor(time%60), ms = Math.floor((time%1)*100);
      ui.textContent = String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')+'.'+String(ms).padStart(2,'0');
      
      // Move road
      racers.forEach(r => {
        r.seg.position.z += speed * 15;
        if(r.seg.position.z > 15) r.seg.position.z -= 500;
      });
      
      let winner = null;
      karts.forEach((k, i) => {
        k.speed += (0.04 + Math.random()*0.01 - k.speed) * 0.1;
        k.progress += k.speed;
        k.kart.position.z = -k.progress * 8;
        k.x += (k.targetX - k.x) * 0.15;
        k.kart.position.x = k.x;
        k.kart.position.y = Math.sin(time*10+i)*0.03;
        k.kart.rotation.z = -(k.targetX - k.x) * 0.5;
        
        if(k.progress > 45 && !winner) {
          winner = k;
          running = false;
          document.getElementById('status').textContent = 'ðŸ† ' + names[i] + ' WINS! ðŸ†';
          document.getElementById('start').style.display = 'block';
          document.querySelector('#start h1').textContent = names[i] + ' WINS!';
        }
      });
      
      const camKart = karts[0].kart;
      camera.position.z = camKart.position.z + 8;
      camera.position.x = camKart.position.x * 0.3;
      
      renderer.render(scene, camera);
    }
    
    onresize = () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    };
    
    update();
  </script>
</body>
</html>
